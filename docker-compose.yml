version: '3.8'

services:
  postgres:
    image: harbor.narvanventures.com/dockerhub/postgres:14
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    command: >
      -c wal_level=logical
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c listen_addresses=*
    volumes:
      - ./pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  starrocks:
    image: harbor.narvanventures.com/dockerhub/starrocks/allin1-ubuntu:latest
    container_name: starrocks
    ports:
      - "8030:8030"
      - "8040:8040"
      - "9030:9030"
      - "9050:9050"
      - "9060:9060"
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    volumes:
      - ./starrocks/data:/opt/starrocks
    environment:
      STARROCKS_FE_ARGS: "--daemon"
      STARROCKS_BE_ARGS: "--daemon"
    healthcheck:
      test: ["CMD", "mysql", "-h", "127.0.0.1", "-P", "9030", "-uroot", "-e", "SHOW DATABASES;"]
      interval: 10s
      timeout: 5s
      retries: 10

  jobmanager:
    image: harbor.narvanventures.com/dockerhub/flink:1.17-scala_2.12
    container_name: jobmanager
    command: jobmanager
    ports:
      - "8081:8081"
    volumes:
      - ./flink_libs/flink-sql-connector-postgres-cdc-2.4.0.jar:/opt/flink/lib/flink-sql-connector-postgres-cdc-2.4.0.jar
      - ./flink_libs/flink-connector-starrocks-1.2.10_flink-1.17.jar:/opt/flink/lib/flink-connector-starrocks-1.2.10_flink-1.17.jar
      - ./sql:/opt/flink/sql

    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
    depends_on:
      - starrocks

  taskmanager:
    image: harbor.narvanventures.com/dockerhub/flink:1.17-scala_2.12
    container_name: taskmanager
    command: taskmanager
    volumes:
      - ./flink_libs/flink-sql-connector-postgres-cdc-2.4.0.jar:/opt/flink/lib/flink-sql-connector-postgres-cdc-2.4.0.jar
      - ./flink_libs/flink-connector-starrocks-1.2.10_flink-1.17.jar:/opt/flink/lib/flink-connector-starrocks-1.2.10_flink-1.17.jar
      - ./sql:/opt/flink/sql

    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
    depends_on:
      - jobmanager

volumes:
  pg_data:
  starrocks_data:
